<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard | UMS</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="/css/Collection.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
  <div id="sidebar">
    <div>
      <div class="brand">
        <img src="/images/logo.jpg" alt="UMS Logo" />
        <h5>Uniform Management System</h5>
      </div>

      <ul class="nav flex-column nav-links mt-3">
        <li class="nav-item"><a href="/admin/index" class="nav-link"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
        <li class="nav-item"><a href="/admin/uniform" class="nav-link"><i class="bi bi-plus-lg"></i> Add Uniform</a></li>
        <li class="nav-item"><a href="/admin/collection" class="nav-link active"><i class="bi bi-collection"></i> Uniforms</a></li>
        <li class="nav-item"><a href="/admin/users" class="nav-link"><i class="bi bi-people"></i> Users</a></li>
        <li class="nav-item"><a href="/admin/request" class="nav-link"><i class="bi bi-inbox"></i> Uniform Requests</a></li>
        <li class="nav-item">
            <a href="/admin/history" class="nav-link">
            <i class="bi bi-clock-history"></i> History
            </a>
        </li>
      </ul>
    </div>

    <div class="sidebar-footer">
      <button id="logoutBtn" class="logout-btn d-flex align-items-center justify-content-center gap-2">
        <i class="bi bi-box-arrow-right"></i> Logout
      </button>
    </div>
  </div>

  <div class="main-content">
    <h2>Uniforms</h2>
    <hr>

  <div class="row g-4">
    <% if (uniforms && uniforms.length > 0) { %>
      <% uniforms.forEach(u => { %>
        <% if (u.availability === 'Available' || (user && user.role === 'admin')) { %>
          <div class="col-md-4 col-lg-3">
            <div class="card uniform-card shadow-sm position-relative">
              <img src="<%= u.image && u.image !== '' ? u.image : '/images/default-uniform.jpg' %>" 
                  alt="Uniform Image"
                  class="card-img-top uniform-img">
              <div class="card-body text-center">
                <p class="card-text mb-1"><i class="bi bi-tags"></i> <%= u.category %></p>
                <p class="card-text mb-1"><i class="bi bi-diagram-3"></i> Type: <strong><%= u.type %></strong></p>
                <p class="card-text mb-1"><i class="bi bi-rulers"></i> Size: <strong><%= u.size %></strong></p>
                <p class="card-text mb-1"><i class="bi bi-person-badge"></i> <%= u.gender %></p>
                <p class="card-text text-muted small"><i class="bi bi-mortarboard"></i> <%= u.yearLevel || 'All Year Levels' %></p>

                <% if (user && user.role === 'admin') { %>
                  <div class="d-flex justify-content-center gap-2 mt-2">
                    <button class="btn btn-sm btn-primary edit-btn" 
                            data-id="<%= u._id %>"
                            data-category="<%= u.category %>"
                            data-type="<%= u.type %>"
                            data-availability="<%= u.availability %>">
                      <i class="bi bi-pencil-square"></i>
                    </button>

                    <form class="availability-form" data-id="<%= u._id %>">
                      <input type="hidden" name="availability" value="<%= u.availability === 'Available' ? 'Not Available' : 'Available' %>">
                      <button type="button" class="btn btn-sm toggle-btn <%= u.availability === 'Available' ? 'btn-danger' : 'btn-success' %>">
                        <%= u.availability === 'Available' ? 'Turn OFF' : 'Turn ON' %>
                      </button>
                    </form>

                    <button type="button" class="btn btn-sm btn-danger delete-btn" data-id="<%= u._id %>">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                <% } %>
              </div>
            </div>
          </div>
        <% } %>
      <% }) %>
    <% } else { %>
      <p class="text-center text-muted">No uniforms found.</p>
    <% } %>
  </div>
</div>

<div class="modal fade" id="editUniformModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="editUniformForm" action="/admin/uniform/edit" enctype="multipart/form-data">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Edit Uniform</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="id" id="uniformId">
          <div class="mb-3">
            <label class="form-label">Category</label>
            <input type="text" class="form-control" name="category" id="uniformCategory" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Type</label>
            <input type="text" class="form-control" name="type" id="uniformType" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Availability</label>
            <select class="form-select" name="availability" id="uniformAvailability">
              <option value="Available">Available</option>
              <option value="Not Available">Not Available</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Image</label>
            <input type="file" class="form-control" name="image" id="uniformImage">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/js/Logout.js"></script>
  <script>
  document.addEventListener("DOMContentLoaded", () => {

    document.querySelectorAll(".availability-form").forEach(form => {
      const button = form.querySelector(".toggle-btn");
      button.addEventListener("click", async () => {
        const uniformId = form.dataset.id;
        const newAvailability = form.querySelector("input[name='availability']").value;

        const confirm = await Swal.fire({
          title: "Toggle Availability",
          text: `Do you want to mark this uniform as "${newAvailability}"?`,
          icon: "question",
          showCancelButton: true
        });

        if (confirm.isConfirmed) {
          try {
            const res = await fetch(`/uniforms/${uniformId}/availability`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ availability: newAvailability })
            });
            const data = await res.json();
            if (!data.success) throw new Error(data.message);

            Swal.fire({ icon: "success", title: "Updated!", text: data.message, timer: 1500, showConfirmButton: false });

            if (data.newAvailability === "Available") {
              button.classList.replace("btn-success", "btn-danger");
              button.textContent = "Turn OFF";
              form.querySelector("input[name='availability']").value = "Not Available";
            } else {
              button.classList.replace("btn-danger", "btn-success");
              button.textContent = "Turn ON";
              form.querySelector("input[name='availability']").value = "Available";
              form.closest(".col-md-4").style.display = "none";
            }

          } catch (err) {
            Swal.fire("Error", err.message || "Something went wrong.", "error");
          }
        }
      });
    });

    document.querySelectorAll(".delete-btn").forEach(btn => {
      btn.addEventListener("click", async () => {
        const uniformId = btn.dataset.id;
        const confirm = await Swal.fire({
          title: "Are you sure?",
          text: "You won't be able to revert this!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#d33",
          cancelButtonColor: "#3085d6",
          confirmButtonText: "Yes, delete it!"
        });

        if (confirm.isConfirmed) {
          try {
            const res = await fetch(`/admin/delete/${uniformId}`, {
              method: "DELETE",
              headers: { "Content-Type": "application/json" }
            });
            const data = await res.json();
            if (!data.success) throw new Error(data.message);

            Swal.fire({ icon: "success", title: "Deleted!", text: data.message, timer: 1500, showConfirmButton: false });
            btn.closest(".col-md-4").remove();

          } catch (err) {
            Swal.fire("Error", "Something went wrong while deleting.", "error");
          }
        }
      });
    });

    const editForm = document.getElementById("editUniformForm");
    const editModal = new bootstrap.Modal(document.getElementById("editUniformModal"));

    document.querySelectorAll(".edit-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.getElementById("uniformId").value = btn.dataset.id;
        document.getElementById("uniformCategory").value = btn.dataset.category;
        document.getElementById("uniformType").value = btn.dataset.type;
        document.getElementById("uniformAvailability").value = btn.dataset.availability;
        editModal.show();
      });
    });

    editForm.addEventListener("submit", async e => {
      e.preventDefault();
      const formData = new FormData(editForm);
      try {
        const res = await fetch("/admin/uniform/edit", { method: "POST", body: formData });
        const data = await res.json();
        if (!data.success) throw new Error(data.message);

        Swal.fire({ icon: "success", title: "Updated!", text: data.message, timer: 1500, showConfirmButton: false });
        editModal.hide();
        setTimeout(() => location.reload(), 600);
      } catch (err) {
        Swal.fire("Error", err.message, "error");
      }
    });

  });
  </script>
</body>
</html>
