<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard | UMS</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="/css/AdminDashboard.css">
  <link rel="stylesheet" href="/css/History.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <div id="sidebar">
    <div>
      <div class="brand">
        <img src="/images/logo_college.png" alt="UMS Logo" />
        <h5>Uniform Management System</h5>
      </div>

      <ul class="nav flex-column nav-links mt-3">
        <li class="nav-item"><a href="/admin/index" class="nav-link"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
        <li class="nav-item"><a href="/admin/uniform" class="nav-link"><i class="bi bi-plus-lg"></i> Add Uniform</a></li>
        <li class="nav-item"><a href="/admin/collection" class="nav-link"><i class="bi bi-collection"></i> Uniforms</a></li>
        <li class="nav-item"><a href="/admin/users" class="nav-link"><i class="bi bi-people"></i> Users</a></li>
        <li class="nav-item"><a href="/admin/request" class="nav-link"><i class="bi bi-inbox"></i> Uniform Requests</a></li>
        <li class="nav-item"><a href="/admin/history" class="nav-link active"><i class="bi bi-clock-history"></i> History</a></li>
      </ul>
    </div>

    <div class="sidebar-footer">
      <button id="logoutBtn" class="logout-btn d-flex align-items-center justify-content-center gap-2">
        <i class="bi bi-box-arrow-right"></i> Logout
      </button>
    </div>
  </div>

  <div class="main-content">
    <h2>History</h2>
    <hr>

    <div class="row g-2 align-items-center mb-3">
      <div class="col-md-8 d-flex align-items-center">
        <div class="input-group w-75">
          <span class="input-group-text bg-primary text-white"><i class="bi bi-search"></i></span>
          <input type="text" id="searchInput" class="form-control" placeholder="Search by name, email, or uniform..." />
        </div>
      </div>
      <div class="col-md-4 d-flex justify-content-end">
        <form method="get" class="w-auto">
          <select name="status" class="form-select" onchange="this.form.submit()">
            <option value="All" <%= statusFilter === 'All' ? 'selected' : '' %>>All</option>
            <option value="Completed" <%= statusFilter === 'Completed' ? 'selected' : '' %>>Completed</option>
            <option value="Rejected" <%= statusFilter === 'Rejected' ? 'selected' : '' %>>Rejected</option>
            <option value="Cancelled" <%= statusFilter === 'Cancelled' ? 'selected' : '' %>>Cancelled</option>
          </select>
        </form>
      </div>
    </div>

    <% if (requests && requests.length > 0) { %>
      <div class="table-responsive shadow-sm rounded bg-white p-3 history-table">
        <table class="table table-hover align-middle mb-0" id="historyTable">
          <thead class="table-primary text-center text-dark">
            <tr>
              <th>#</th>
              <th>User</th>
              <th>Email</th>
              <th>Uniform</th>
              <th>Category</th>
              <th>Type</th>
              <th>Size</th>
              <th>Gender</th>
              <th>Status</th>
              <th>Requested At</th>
            </tr>
          </thead>
          <tbody>
            <% requests.forEach((req, index) => { %>
              <tr>
                <td class="text-center"><%= index + 1 %></td>
                <td><%= req.user.firstName %> <%= req.user.lastName %></td>
                <td><%= req.user.email %></td>
                <td><%= req.uniform.category %> - <%= req.uniform.type %></td>
                <td><%= req.uniform.category %></td>
                <td><%= req.uniform.type %></td>
                <td class="text-center"><%= req.uniform.size %></td>
                <td class="text-center"><%= req.uniform.gender %></td>
                <td class="text-center">
                  <% if(req.status === 'Completed') { %>
                    <span class="badge bg-success">Completed</span>
                  <% } else if(req.status === 'Rejected') { %>
                    <span class="badge bg-danger">Rejected</span>
                  <% } else if(req.status === 'Cancelled') { %>
                    <span class="badge bg-secondary">Cancelled</span>
                  <% } %>
                </td>
                <td class="text-center"><%= req.createdAt.toLocaleString() %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>

    <% if (totalPages > 1) { %>
      <nav class="mt-3">
        <ul class="pagination justify-content-center">
          <% for (let i = 1; i <= totalPages; i++) { %>
            <li class="page-item <%= currentPage === i ? 'active' : '' %>">
              <a
                class="page-link <%= currentPage === i ? 'text-light bg-primary border-primary' : '' %>"
                href="?page=<%= i %>&status=<%= statusFilter %>&search=<%= search || '' %>"
              >
                <%= i %>
              </a>
            </li>
          <% } %>
        </ul>
      </nav>
    <% } %>

    <% } else { %>
      <p class="text-center text-muted mt-5">No history found for this search or status.</p>
    <% } %>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const searchInput = document.getElementById('searchInput');
      const tableBody = document.querySelector('#historyTable tbody');
      const rows = document.querySelectorAll('#historyTable tbody tr');

      const noResults = document.createElement('p');
      noResults.textContent = 'No results found.';
      noResults.className = 'text-center text-muted mt-3';
      noResults.style.display = 'none';
      tableBody.parentElement.parentElement.appendChild(noResults);

      searchInput.addEventListener('keyup', function () {
        const query = this.value.toLowerCase();
        let visibleCount = 0;

        rows.forEach(row => {
          const text = row.textContent.toLowerCase();
          if (text.includes(query)) {
            row.style.display = '';
            visibleCount++;
          } else {
            row.style.display = 'none';
          }
        });

        noResults.style.display = visibleCount === 0 ? 'block' : 'none';
      });
    });
  </script>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/js/Logout.js"></script>
</body>
</html>
