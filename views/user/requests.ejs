<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title><%= title %> | UMS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="/css/Request.css">
</head>
<body>
  <div id="sidebar">
    <div>
      <div class="brand">
        <img src="/images/logo.jpg" alt="UMS Logo" />
        <h5>Uniform Management System</h5>
      </div>
      <ul class="nav flex-column nav-links mt-3">
        <li class="nav-item">
          <a href="/user/index" class="nav-link">
            <i class="bi bi-speedometer2"></i> Dashboard
          </a>
        </li>
        <li class="nav-item">
          <a href="/user/request" class="nav-link">
            <i class="bi bi-file-earmark-text"></i> Request Uniform
          </a>
        </li>
        <li class="nav-item">
          <a href="/user/requests" class="nav-link active">
            <i class="bi bi-list-check"></i> My Requests
          </a>
        </li>
        <li class="nav-item">
          <a href="/user/profile" class="nav-link">
            <i class="bi bi-person-lines-fill"></i> Profile
          </a>
        </li>
      </ul>
    </div>
    <div class="sidebar-footer">
      <button id="logoutBtn" class="logout-btn d-flex align-items-center justify-content-center gap-2">
        <i class="bi bi-box-arrow-right"></i> Logout
      </button>
    </div>
  </div>
  <div class="main-content">
    <h2>My Uniform Requests</h2>
    <hr>

  <div class="d-flex justify-content-between mb-3">
    <input type="text" id="searchInput" class="form-control me-2" placeholder="Search by category, type, size, gender..." value="<%= search %>">
    <select id="statusFilter" class="form-select me-2">
      <option value="">All Statuses</option>
      <option value="pending" <%= statusFilter==='pending'?'selected':'' %>>Pending</option>
      <option value="approved" <%= statusFilter==='approved'?'selected':'' %>>Approved</option>
      <option value="rejected" <%= statusFilter==='rejected'?'selected':'' %>>Rejected</option>
      <option value="completed" <%= statusFilter==='completed'?'selected':'' %>>Completed</option>
      <option value="cancelled" <%= statusFilter==='cancelled'?'selected':'' %>>Cancelled</option>
    </select>
  </div>

    <% if (requests.length > 0) { %>
    <div class="table-responsive">
      <table class="table table-hover align-middle" id="requestsTable">
        <thead class="table-primary">
          <tr>
            <th>Image</th>
            <th>Category</th>
            <th>Type</th>
            <th>Size</th>
            <th>Gender</th>
            <th>Status</th>
            <th>Requested On</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <% requests.forEach(request => { %>
            <tr>
              <td><img src="<%= request.uniform.image %>" class="rounded shadow-sm" style="height:60px;width:60px;object-fit:cover;"></td>
              <td class="category"><%= request.uniform.category %></td>
              <td class="type"><%= request.uniform.type %></td>
              <td class="size"><%= request.uniform.size %></td>
              <td class="gender"><%= request.uniform.gender %></td>
              <td class="status">
                <% const status = request.status.toLowerCase(); %>
                <% if (status === 'pending') { %>
                  <span class="badge bg-warning text-dark">Pending</span>
                <% } else if (status === 'approved') { %>
                  <span class="badge bg-success">Approved</span>
                <% } else if (status === 'rejected' || status === 'processed') { %>
                  <span class="badge bg-danger">Rejected</span>
                <% } else if (status === 'completed') { %>
                  <span class="badge bg-info text-dark">Completed</span>
                <% } else if (status === 'cancelled') { %>
                  <span class="badge bg-secondary text-dark">Cancelled</span>
                <% } else { %>
                  <span class="badge bg-secondary text-dark"><%= request.status %></span>
                <% } %>
              </td>
              <td><%= new Date(request.createdAt).toLocaleDateString() %></td>
              <td>
                <% if (request.status === 'Pending') { %>
                  <button class="btn btn-sm btn-danger cancel-btn" data-id="<%= request._id %>">Cancel</button>
                <% } %>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
      <p id="noResults" class="text-center mt-3 text-muted" style="display:none;">No results found.</p>
    </div>

      <div class="d-flex justify-content-center mt-3">
        <nav>
          <ul class="pagination pagination-sm">
            <% if (currentPage > 1) { %>
              <li class="page-item">
                <a class="page-link text-primary" href="?page=<%= currentPage - 1 %>">&laquo; Prev</a>
              </li>
            <% } %>
            <% for (let i = 1; i <= totalPages; i++) { %>
              <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                <a class="page-link <%= i === currentPage ? 'bg-primary text-white border-0' : 'text-primary' %>" href="?page=<%= i %>"><%= i %></a>
              </li>
            <% } %>
            <% if (currentPage < totalPages) { %>
              <li class="page-item">
                <a class="page-link text-primary" href="?page=<%= currentPage + 1 %>">Next &raquo;</a>
              </li>
            <% } %>
          </ul>
        </nav>
      </div>
    <% } else { %>
      <p class="text-muted text-center mt-4">You havenâ€™t requested any uniforms yet.</p>
    <% } %>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/js/Logout.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    document.querySelectorAll('.cancel-btn').forEach(button => {
      button.addEventListener('click', async () => {
        const requestId = button.getAttribute('data-id');
        const result = await Swal.fire({
          icon: 'warning',
          title: 'Are you sure?',
          text: "Do you want to cancel this request?",
          showCancelButton: true,
          confirmButtonColor: '#dc3545',
          cancelButtonColor: '#6c757d',
          confirmButtonText: 'Yes, cancel it!'
        });
        if (result.isConfirmed) {
          try {
            const response = await fetch('/user/cancel', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ requestId })
            });
            const data = await response.json();
            if (data.success) {
              Swal.fire('Cancelled!', data.message, 'success').then(() => {
                window.location.reload();
              });
            } else {
              Swal.fire('Oops!', data.message, 'warning');
            }
          } catch (err) {
            Swal.fire('Error', 'Something went wrong. Please try again.', 'error');
          }
        }
      });
    });
  </script>
  <script>
  const searchInput = document.getElementById('searchInput');
  const statusFilter = document.getElementById('statusFilter');
  const table = document.getElementById('requestsTable');
  const noResults = document.getElementById('noResults');

  function filterTable() {
    const searchText = searchInput.value.toLowerCase();
    const selectedStatus = statusFilter.value.toLowerCase();
    let visibleCount = 0;

    table.querySelectorAll('tbody tr').forEach(row => {
      const category = row.querySelector('.category').textContent.toLowerCase();
      const type = row.querySelector('.type').textContent.toLowerCase();
      const size = row.querySelector('.size').textContent.toLowerCase();
      const gender = row.querySelector('.gender').textContent.toLowerCase();
      const status = row.querySelector('.status span').textContent.toLowerCase();

      const matchesSearch = category.includes(searchText) || type.includes(searchText) || size.includes(searchText) || gender.includes(searchText);
      const matchesStatus = !selectedStatus || status === selectedStatus || (status === 'processed' && selectedStatus === 'rejected');

      if (matchesSearch && matchesStatus) {
        row.style.display = '';
        visibleCount++;
      } else {
        row.style.display = 'none';
      }
    });

    noResults.style.display = visibleCount === 0 ? 'block' : 'none';
  }

  searchInput.addEventListener('input', filterTable);
  statusFilter.addEventListener('change', filterTable);
</script>
</body>
</html>
