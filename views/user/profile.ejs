<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Dashboard | UMS</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="/css/Profile.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

  <div id="sidebar">
    <div>
      <div class="brand">
        <img src="/images/logo.jpg" alt="UMS Logo" />
        <h5>Uniform Management System</h5>
      </div>

      <ul class="nav flex-column nav-links mt-3">
        <li class="nav-item">
          <a href="/user/index" class="nav-link">
            <i class="bi bi-speedometer2"></i> Dashboard
          </a>
        </li>
        <li class="nav-item">
          <a href="/user/request" class="nav-link">
            <i class="bi bi-file-earmark-text"></i> Request Uniform
          </a>
        </li>
        <li class="nav-item">
          <a href="/user/requests" class="nav-link">
            <i class="bi bi-list-check"></i> My Requests
          </a>
        </li>
        <li class="nav-item">
          <a href="/user/profile" class="nav-link active">
            <i class="bi bi-person-lines-fill"></i> Profile
          </a>
        </li>
      </ul>
    </div>

    <div class="sidebar-footer">
      <button id="logoutBtn" class="logout-btn d-flex align-items-center justify-content-center gap-2">
        <i class="bi bi-box-arrow-right"></i> Logout
      </button>
    </div>
  </div>

  <div class="main-content">
    <h2>Hello, <%= session && session.user ? session.user.firstName : 'User' %></h2>
    <p class="text-muted fs-5">
    Manage your personal information and keep your profile up to date.
    </p>
    <hr>
    <div class="container mt-4">
      <div class="card shadow-sm p-4">
        <h4 class="mb-3">Profile Information</h4>
        <form action="/user/profile/update" method="POST" id="profileForm">
          <div class="row g-3">

            <div class="col-md-6">
              <label class="form-label">First Name</label>
              <input type="text" name="firstName" class="form-control" 
                    value="<%= session.user.firstName %>" required maxlength="30">
            </div>

            <div class="col-md-6">
              <label class="form-label">Last Name</label>
              <input type="text" name="lastName" class="form-control" 
                    value="<%= session.user.lastName %>" required maxlength="30">
            </div>

            <div class="col-md-6">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" value="<%= session.user.email %>" readonly>
              <small class="text-muted text-danger"><span class="text-danger"><i class="bi bi-radioactive"></i> Cannot be changed</span></small>
            </div>

            <div class="col-md-6">
              <label class="form-label">Phone</label>
              <input type="text" name="phone" class="form-control" 
                    value="<%= session.user.phone %>" required maxlength="11">
            </div>

            <div class="col-md-6">
              <label class="form-label">Gender</label>
              <select name="gender" class="form-select" required>
                <option value="" disabled>Select Gender</option>
                <option value="Male" <%= session.user.gender === 'Male' ? 'selected' : '' %>>Male</option>
                <option value="Female" <%= session.user.gender === 'Female' ? 'selected' : '' %>>Female</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label">Year Level</label>
              <input type="text" class="form-control" value="<%= session.user.yearLevel %>" readonly>
              <small class="text-muted"><span class="text-danger"><i class="bi bi-radioactive"></i> Cannot be changed</span></small>
            </div>

            <div class="col-md-6">
              <label class="form-label">Course</label>
              <input type="text" class="form-control" value="<%= session.user.course %>" readonly>
              <small class="text-muted text-danger"><span class="text-danger"><i class="bi bi-radioactive"></i> Cannot be changed</span></small>
            </div>
          </div>

          <div class="mt-4 text-end">
            <button type="submit" class="btn btn-primary px-4">
              <i class="bi bi-save me-2"></i>Save Changes
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="/js/Logout.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
    const profileForm = document.getElementById("profileForm");

    const originalValues = {
        firstName: profileForm.firstName.value,
        lastName: profileForm.lastName.value,
        phone: profileForm.phone.value
    };

    Object.keys(originalValues).forEach((key) => {
        profileForm[key].addEventListener("input", (e) => {
        if (e.target.value !== originalValues[key]) {
            e.target.style.backgroundColor = "#d1fae5"; 
        } else {
            e.target.style.backgroundColor = ""; 
        }
        });
    });

    profileForm.addEventListener("submit", (e) => {
        e.preventDefault();

        const firstName = profileForm.firstName.value.trim();
        const lastName = profileForm.lastName.value.trim();
        const phone = profileForm.phone.value.trim();

        const nameRegex = /^[A-Za-z\s]{1,30}$/;
        const phoneRegex = /^[0-9]{1,11}$/;

        if (!nameRegex.test(firstName)) {
        Swal.fire("Invalid Input", "First Name cannot contain numbers or symbols and max 30 characters.", "warning");
        return;
        }

        if (!nameRegex.test(lastName)) {
        Swal.fire("Invalid Input", "Last Name cannot contain numbers or symbols and max 30 characters.", "warning");
        return;
        }

        if (!phoneRegex.test(phone)) {
        Swal.fire("Invalid Input", "Phone number must contain only numbers and maximum 11 digits.", "warning");
        return;
        }

        Swal.fire({
        title: "Are you sure?",
        text: "You are about to save your profile changes.",
        icon: "question",
        showCancelButton: true,
        confirmButtonText: "Yes, save it",
        cancelButtonText: "Cancel",
        reverseButtons: true,
        focusCancel: true,
        customClass: {
            confirmButton: "btn btn-success",
            cancelButton: "btn btn-danger me-2"
        },
        buttonsStyling: false
        }).then((result) => {
        if (result.isConfirmed) {
            profileForm.submit();
        }
        });
    });

    const params = new URLSearchParams(window.location.search);
    if (params.get("updated")) {
        Swal.fire({
        icon: "success",
        title: "Profile Updated",
        text: "Your profile changes have been saved successfully.",
        timer: 2000,
        showConfirmButton: false
        }).then(() => {
        window.history.replaceState({}, document.title, "/user/profile");
        });
    }
    });

</script>

</body>
</html>
